<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Oracle Multilingual</title>
  <link rel="stylesheet" href="style.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
  </style>
</head>
<body>

  <div class="chat-wrapper">
    <div class="chat-header">Lize IA</div>
    <div class="chat-messages" id="chat-messages"></div>

    <div class="loading" id="loading">Processando...</div>

    <div class="input-container">
      <input type="text" id="user-input" placeholder="Digite sua mensagem...">
      <button id="mic-button" title="Iniciar/Parar ditado">üé§</button>
      <button onclick="sendMessage()">‚û§</button>
    </div>
  </div>
  
<script>

let currentUtteranceBtn = null;

// Limpa texto antes de falar
function sanitizeForSpeech(text) {
    const noEmojis = text.replace(/[\p{Emoji_Presentation}\p{Emoji}\uFE0F]/gu, '');
    return noEmojis.replace(/[,*#]/g, '').trim();
}

// Fun√ß√£o TTS com Play / Stop no mesmo bot√£o
function speakText(text, button) {
    const cleanText = sanitizeForSpeech(text);

    if (!cleanText) return;

    if (speechSynthesis.speaking) {
        speechSynthesis.cancel();

        if (currentUtteranceBtn === button) {
            currentUtteranceBtn = null;
            button.textContent = "üîä";
            return;
        }
    }

    const utterance = new SpeechSynthesisUtterance(cleanText);
    utterance.lang = "pt-BR";

    currentUtteranceBtn = button;
    button.textContent = "‚èπ";

    utterance.onend = () => {
        button.textContent = "üîä";
        currentUtteranceBtn = null;
    };

    utterance.onerror = () => {
        button.textContent = "üîä";
        currentUtteranceBtn = null;
    };

    speechSynthesis.speak(utterance);
}

// Adiciona mensagem no chat
function addMessage(text, isUser, executionTime = null) {
    const messagesDiv = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;

    const textSpan = document.createElement('span');

    if (executionTime !== null) {
        const formattedTime = Number(executionTime).toFixed(2);
        textSpan.textContent = `[${formattedTime}s] ${text}`;
    } else {
        textSpan.textContent = text;
    }

    messageDiv.appendChild(textSpan);

    // Se for IA adiciona bot√£o de fala
    if (!isUser) {
        const speakBtn = document.createElement('button');
        speakBtn.textContent = "üîä";
        speakBtn.className = "speak-btn";

        speakBtn.onclick = () => {
            speakText(textSpan.textContent, speakBtn);
        };

        messageDiv.appendChild(speakBtn);
    }

    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// =========================
// üéô SPEECH TO TEXT
// =========================
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;
let recognizing = false;
let sendOnStop = false;
let finalTranscript = '';

if (SpeechRecognition) {

    recognition = new SpeechRecognition();
    recognition.lang = 'pt-BR';
    recognition.interimResults = true;
    recognition.continuous = true;

    recognition.addEventListener('start', () => {
        finalTranscript = '';
        recognizing = true;
        document.getElementById('mic-button').classList.add('listening');
        document.getElementById("mic-button").textContent = "‚èπ";
    });

    recognition.addEventListener('result', (event) => {
        let interimTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; ++i) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript + " ";
            } else {
                interimTranscript += transcript;
            }
        }

        document.getElementById('user-input').value = finalTranscript || interimTranscript;
    });

    recognition.addEventListener('end', () => {
        recognizing = false;
        document.getElementById('mic-button').classList.remove('listening');
        document.getElementById("mic-button").textContent = "üé§";

        if (sendOnStop && finalTranscript.trim()) {
            const input = document.getElementById('user-input');
            input.value = finalTranscript.trim();
            sendMessage();
        }

        sendOnStop = false;
    });
}

// =========================
// üé§ BOT√ÉO DO MICROFONE
// =========================
const micButton = document.getElementById('mic-button');

micButton.addEventListener('click', () => {

    if (!recognition) {
        alert("Seu navegador n√£o suporta reconhecimento de voz. Use Google Chrome.");
        return;
    }

    // Se N√ÉO estiver ouvindo ‚Üí come√ßa
    if (!recognizing) {
        sendOnStop = true;
        recognition.start();
    } 
    // Se J√Å estiver ouvindo ‚Üí para
    else {
        recognition.stop();
    }
});

// =========================
// ENVIO DE MENSAGEM
// =========================
async function sendMessage() {
    const input = document.getElementById('user-input');
    const loading = document.getElementById('loading');
    const message = input.value.trim();

    if (!message) return;

    addMessage(message, true);
    input.value = '';
    loading.style.display = 'block';

    try {
        const response = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });

        const data = await response.json();
        addMessage(data.response, false);

    } catch (error) {
        addMessage('Erro ao processar a mensagem.', false);
    } finally {
        loading.style.display = 'none';
    }
}

// Enter envia
document.getElementById('user-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

</script>


</body>
</html>
